#!/usr/bin/env bash

set -eu

algorithms=(md5 sha{1,224,256,384,512} b2)

me=${0##*/}
usage="Rename files to hashes based on contents.

Usage:
    $me [OPTIONS] ALGORITHM FILE...

Options:
    -f    use -f instead of -i in the generated mv commands

Where ALGORITHM is one of: ${algorithms[*]}
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

extname() {
    awk 'match($0, /(\.[[:alnum:]]+)+$/) { print substr($0, RSTART, RLENGTH) }' <<<"$1"
}

mkbr_options=()

while getopts ":fh" option; do
    case $option in
    f) mkbr_options+=(-f) ;;
    h) usage ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

if [[ ! -v 1 ]]; then
    die "No algorithm provided"
fi

for possible_algorithm in "${algorithms[@]}"; do
    if [[ $possible_algorithm == "$1" ]]; then
        algorithm=$possible_algorithm
        shift
        break
    fi
done

if [[ ! -v algorithm ]]; then
    die "Invalid digest algorithm"
fi

temp_dir=$(mktemp -d -t "${me}.XXXXXXXXXX")
printf -v cleanup "rm -rf %q" "$temp_dir"
trap "$cleanup" INT TERM EXIT

src_list=$temp_dir/src
dst_list=$temp_dir/dst

for src in "$@"; do
    [[ -f $src && -r $src ]] || continue

    dir=$(dirname "$src")
    ext=$(extname "$src")
    base=$("$algorithm"sum "$src" | awk '{print $1}')
    dst=$dir/$base$ext

    echo "$src" >>"$src_list"
    echo "$dst" >>"$dst_list"
done

mkbr "${mkbr_options[@]}" "$src_list" "$dst_list"

#!/usr/bin/env bash

# Initialize a Deno prefix.
# Usage: enable-deno [VERSION]

set -euo pipefail

REPO=denoland/deno
KERNEL=$(uname --kernel-name)
MACHINE=$(uname --machine)

version=${1:?missing version}
tag=v$version

if ! git ls-remote --tags --refs --exit-code "https://github.com/$REPO" "refs/tags/$tag" >/dev/null; then
    printf "Invalid version: %s\n" "$version" >&2
    exit 1
fi

release_json=$(curl -sSL "https://api.github.com/repos/$REPO/releases/tags/$tag")

if ! jq -er .tag_name <<<"$release_json" >/dev/null; then
    printf "No release for version: %s\n" "$version" >&2
    exit 1
fi

prefix=${XDG_DATA_HOME:-$HOME/.local/share}/deno/$version
archive_file=${XDG_CACHE_HOME:-$HOME/.cache}/deno/deno-$version.zip

if [[ ! -f $archive_file ]]; then
    case $KERNEL in
    Darwin) kernel=apple-darwin ;;
    Linux) kernel=unknown-linux-gnu ;;
    esac

    machine=${MACHINE/arm/aarch}

    archive_url=$(jq -er --arg name "deno-$machine-$kernel.zip" '.assets[] | select(.name == $name).browser_download_url' <<<"$release_json")

    printf "Downloading Deno v%s: %s\n" "$version" "$archive_url"
    mkdir -p "$(dirname "$archive_file")"
    curl -L -o "$archive_file" "$archive_url"
fi

if [[ -d $prefix ]]; then
    printf "Deno v%s is already installed at: %q\n" "$version" "$prefix"
    exit 0
fi

mkdir -p "$prefix"/bin
unzip -d "$prefix"/bin -o "$archive_file"

printf "Deno v%s is now installed at: %q\n" "$version" "$prefix"

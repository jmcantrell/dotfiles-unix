#!/usr/bin/env bash

set -eu

dir=${PYENV_ROOT:-$HOME/.pyenv}

if [[ -d $dir ]]; then
    cd "$dir"
    git pull origin master
else
    git clone https://github.com/pyenv/pyenv.git "$dir"
    cd "$dir"
fi

add_plugin() {
    local name=$1
    local url=$2

    plugin_dir=$dir/plugins/$name

    if [[ -d $plugin_dir ]]; then
        cd "$plugin_dir"
        git pull origin master
    else
        git clone "$url" "$plugin_dir"
    fi
}

add_plugin pyenv-doctor https://github.com/pyenv/pyenv-doctor.git
add_plugin pyenv-default-packages https://github.com/jawshooah/pyenv-default-packages.git
add_plugin xxenv-latest https://github.com/momo-lab/xxenv-latest.git

cat >"$dir"/default-packages <<-EOF
black
build
flake8
pip-tools
pynvim
twine
wheel
EOF

export PATH=$dir/bin:$dir/shims:$PATH

pyenv latest install --skip-existing

while read -r version; do
    PYENV_VERSION=$version pip install --upgrade pip
done < <(pyenv versions --bare --skip-aliases)

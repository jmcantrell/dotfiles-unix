#!/usr/bin/env bash

# List the submodule paths in this repository.

set -euo pipefail

usage="List the submodule paths in a repository.

Usage:
    ${0##*/} [OPTIONS] [DIRECTORY]

Options:
    -h           show this help message and exit
    -r           recurse into nested submodules
    -z           separate results with a null instead of a newline

Arguments:
    DIRECTORY    look at the submodules in repository DIRECTORY
                 (default: '.')"

field_sep='\n'
foreach_options=()

while getopts ":zrh" option; do
    case $option in
    z) field_sep='\0' ;;
    r) foreach_options+=(--recursive) ;;
    h)
        printf "%s\n" "$usage"
        exit 0
        ;;
    *)
        printf "Invalid option: %s\n" "$OPTARG" >&2
        exit 1
        ;;
    esac
done && shift $((OPTIND - 1))

cd "${1:-$PWD}"

printf -v print_cwd 'printf "%%s\%s" "$PWD"' "$field_sep"
git submodule --quiet foreach "${foreach_options[@]}" "$print_cwd"

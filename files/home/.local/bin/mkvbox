#!/usr/bin/env bash

# Create a new virtualbox guest.
# Usage: mkvbox "Linux" linux.iso

set -eu

name=${1:?missing machine name}
isofile=${2:?missing ISO file}

ostype=${ostype:-Linux_64}
memory=${memory:-4096}
size=${size:-20}
cpus=${cpus:-2}
firmware=${firmware:-bios}

vmsdir=$(
    VBoxManage list systemproperties |
        grep '^Default machine folder:' | cut -d: -f2 |
        sed 's/^[[:space:]]\+//;s/[[:space:]]\+$//'
)

bridgedif=$(
    VBoxManage list bridgedifs |
        grep "^Name:" | head -n1 |
        sed 's/^Name: *\(.*\)$/\1/'
)

VBoxManage createvm \
    --name "$name" --ostype "$ostype" --register

VBoxManage modifyvm "$name" \
    --memory "$memory" --clipboard bidirectional \
    --boot1 dvd --boot2 disk --boot3 none --boot4 none \
    --ioapic on --firmware "$firmware" --rtcuseutc on \
    --cpus "$cpus" --pae on --hwvirtex on \
    --paravirtprovider kvm --nestedpaging on --largepages on \
    --vram 128 --graphicscontroller vmsvga --accelerate3d on \
    --audiocontroller hda --audioin on --audioout on \
    --nic1 bridged --bridgeadapter1 "$bridgedif" \
    --defaultfrontend headless

vdifile=$vmsdir/$name.vdi

VBoxManage createhd \
    --filename "$vdifile" --size $((size * 1024))

VBoxManage storagectl "$name" \
    --name "SATA Controller" \
    --add sata --controller IntelAHCI

VBoxManage storageattach "$name" \
    --storagectl "SATA Controller" \
    --port 0 --device 0 --type hdd \
    --medium "$vdifile"

VBoxManage storagectl "$name" \
    --name "IDE Controller" --add ide

VBoxManage storageattach "$name" \
    --storagectl "IDE Controller" \
    --port 0 --device 0 --type dvddrive \
    --medium "$isofile"

VBoxManage snapshot "$name" take live

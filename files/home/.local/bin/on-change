#!/usr/bin/env bash

set -eu

me=${0##*/}
usage="Run a command when files change.

Usage:
    $me [OPTIONS] COMMAND [ARGUMENT...]

Options:
    -d DIRECTORY    watch DIRECTORY for file changes
                    (can be specified multiple times)
                    (default: $PWD)
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

directories=()

while getopts ":d:h" option; do
    case $option in
    d) directories+=("$OPTARG") ;;
    h) usage ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift "$((OPTIND - 1))"

if ((${#directories[@]} == 0)); then
    directories=("$PWD")
fi

trap 'kill $$' INT

while sleep 0.1; do
    find "${directories[@]}" -type f | entr -acd "$@" || continue
done

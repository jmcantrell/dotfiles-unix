#!/usr/bin/env bash

# Adapted from: https://bbs.archlinux.org/viewtopic.php?pid=431568#p431568

set -euo pipefail

usage="Run a command repeatedly until it succeeds or runs out of retries.

Usage:
    ${0##*/} [OPTIONS] COMMAND [ARGUMENT...]

Options:
    -h           show this help text and exit
    -n NUMBER    try to run COMMAND a maximum of NUMBER times
    -d NUMBER    wait NUMBER seconds between each try"

retries_remaining=-1
delay=0

while getopts ":n:d:h" option; do
    case $option in
    n) retries_remaining=$OPTARG ;;
    d) delay=$OPTARG ;;
    h)
        printf "%s\n" "$usage"
        exit 0
        ;;
    *)
        printf "Invalid option: %s\n" "$OPTARG"
        exit 1
        ;;
    esac
done && shift $((OPTIND - 1))

exit_code=0

while ((retries_remaining != 0)); do
    ((retries_remaining--))

    "$@"
    exit_code=$?
    ((exit_code == 0)) && break

    sleep "$delay"
done

exit "$exit_code"

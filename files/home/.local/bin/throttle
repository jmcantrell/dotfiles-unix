#!/usr/bin/env bash

# Only allow given command to be run once during a given period of time.
# Usage: throttle ID DELAY COMMAND [ARGUMENT...]

set -euo pipefail

if [[ ! -v 1 ]]; then
    printf "The first argument must be a command identifier\n" >&2
    exit 1
fi

if [[ ! -v 2 ]]; then
    printf "The second argument must be a delay specification\n" >&2
    exit 1
fi

if [[ ! $2 =~ ^[0-9.]+(s|m|h|d)?$ ]]; then
    printf "Invalid delay specification: %s\n" "$2" >&2
    printf "See sleep(1) for more information" >&2
    exit 1
fi

id=$1
delay=$2

shift 2

if [[ ! -v 1 ]]; then
    printf "The remaining arguments must be a command\n" >&2
    exit 1
fi

lock_file=$XDG_RUNTIME_DIR/${0##*/}-$id.lock

[[ -e $lock_file ]] && exit 0

printf -v cleanup "rm %q" "$lock_file"
trap '$cleanup' EXIT
touch "$lock_file"

"$@"

sleep "$delay"

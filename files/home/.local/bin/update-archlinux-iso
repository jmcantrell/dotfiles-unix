#!/usr/bin/env bash

# Download the latest Arch Linux ISO, if needed.

set -eu

output_dir=${1:-$HOME/disks}

metadata_file=$(mktemp -t "${0##*/}.XXXXXXXXXX")
printf -v cleanup "rm %q" "$metadata_file"
trap '$cleanup' EXIT

curl -Ls -o "$metadata_file" https://archlinux.org/releng/releases/json

iso_name=$(jq -r .releases[0].torrent.file_name "$metadata_file")
iso_file=$output_dir/$iso_name

if [[ ! -f $iso_file ]]; then
    mkdir -p "$output_dir"
    magnet_uri=$(jq -r .releases[0].magnet_uri "$metadata_file")
    aria2c-torrent -d "$output_dir" --seed-time 0 "$magnet_uri"
fi

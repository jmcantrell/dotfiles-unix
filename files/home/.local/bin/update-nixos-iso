#!/usr/bin/env bash

# Download the latest NixOS ISO, if needed.

set -eu

iso_name=nixos-minimal-x86_64
iso_url=https://channels.nixos.org/nixos-unstable/latest-${iso_name}-linux.iso
iso_url_ver=$(
    curl -sLI "$iso_url" |
        grep '^location:' | awk '{print $2}' |
        sed 's/^[[:space:]]\+//;s/[[:space:]]\+$//'
)

iso_dir=${XDG_DATA_HOME:-$HOME/.local/share}/nixos
iso_file_ver=$iso_dir/${iso_url_ver##*/}

if [[ ! -f $iso_file_ver ]]; then
    mkdir -p "$iso_dir"
    cd "$iso_dir"
    curl -o "$iso_file_ver" "$iso_url_ver"
fi

ln -sfvr "$iso_file_ver" "${iso_name}.iso"

#!/usr/bin/env bash

set -e

me=${0##*/}
usage="Rename files using your preferred editor.
Usage: $me [-h] [FILE...]"

usage() {
    echo "$usage" >&2
    exit "${1:-0}"
}

die() {
    echo "$me: $*" >&2
    exit "${1:-1}"
}

unset OPTIND
while getopts ":hi" option; do
    case $option in
    i) interactive=1 ;;
    h) usage ;;
    *) usage 1 ;;
    esac
done && shift $((OPTIND - 1))

(($# == 0)) && usage 1

temp_dir=$(mktemp -d -t "${me}.XXXXXXXXXX")
trap "rm -rf $(printf "%q" "$temp_dir")" INT TERM EXIT

src_list=$temp_dir/src
dst_list=$temp_dir/dst

for fn in "$@"; do
    [[ -e "$fn" ]] && echo "$fn"
done >"$src_list"

cp "$src_list" "$dst_list"

[[ $EDITOR ]] || EDITOR="vim"

"${EDITOR[@]}" "$dst_list" || die "edit failed"

readarray -t src_lines <"$src_list"
readarray -t dst_lines <"$dst_list"

((${#src_lines[@]} == ${#dst_lines[@]})) || die "lines were added or removed"

for ((i = 0; i <= ${#dst_lines[@]}; i += 1)); do
    src=${src_lines[$i]}
    dst=${dst_lines[$i]}

    if [[ "$src" != "$dst" ]]; then
        # The file may have been moved.
        mkdir -p "$(dirname "$dst")"
        mv ${interactive:--f} ${interactive:+-i} "$src" "$dst"
        echo "$dst"
    fi
done

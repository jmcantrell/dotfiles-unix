#!/usr/bin/env bash

me=${0##*/}
usage="Rename files using your preferred editor.
Usage: $me [-h] [file...]"

unset OPTIND
while getopts ":h" option; do
    case $option in
        h) echo "$usage" >&2; exit 0 ;;
        *) echo "$usage" >&2; exit 1 ;;
    esac
done && shift $((OPTIND - 1))

srctmp=$(mktemp -t "${me}-src.XXXXXXXXXX")
trap "rm -f $(printf "%q" "$srctmp")" INT TERM EXIT

for fn in "$@"; do
    [[ -e "$fn" ]] && echo "$fn"
done >"$srctmp"

dsttmp=$(mktemp -t "${me}-dst.XXXXXXXXXX")
trap "rm -f $(printf "%q" "$dsttmp")" INT TERM EXIT

cat "$srctmp" >"$dsttmp"

if ! ${EDITOR:-vim} "$dsttmp"; then
    echo "$me: edit failed"
    exit 1
fi

readarray -t srclines <"$srctmp"
readarray -t dstlines <"$dsttmp"

if (( ${#srclines[@]} != ${#dstlines[@]} )); then
    echo "$me: lines were added or removed"
    exit 1
fi

for (( i = 0; i <= ${#dstlines[@]}; i += 1 )); do
    srcfn=${srclines[$i]}
    dstfn=${dstlines[$i]}
    dstdir=$(dirname "$dstfn")
    test -d "$dstdir" || mkdir -p "$dstdir"
    if [[ "$srcfn" != "$dstfn" ]]; then
        mv -fv "$srcfn" "$dstfn"
    fi
done

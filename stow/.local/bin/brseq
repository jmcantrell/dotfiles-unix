#!/usr/bin/env bash

set -eu

format=%d/%b_%n%e
start_num=1
increment=1

usage="Rename files as a sequence of numbers.

Usage:
    ${0##*/} [OPTIONS] FILE...

Options:
    -n           dry-run (make no changes)
    -w           equalize width by padding with leading zeroes
    -W NUMBER    pad each number to an exact width with leading zeroes
    -s NUMBER    starting number (default: $start_num)
    -i NUMBER    increment (default: $increment)
    -f FORMAT    file path format (default: $format)

The following placeholders are recognized in FORMAT:
    %n           number of FILE (required)
    %N           total number of files
    %d           directory of FILE
    %b           basename of FILE
    %e           extension of FILE
"

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

declare -a seq_options

while getopts ":f:s:i:W:wnh" option; do
    case $option in
    f) format=$OPTARG ;;
    s) start_num=$OPTARG ;;
    i) increment=$OPTARG ;;
    W) width=$OPTARG ;;
    w) seq_options+=(-w) ;;
    n) dry_run=1 ;;
    h)
        printf "%s\n" "$usage"
        exit
        ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

if [[ $format != *%n* ]]; then
    die "Format does not contain '%n'"
fi

if [[ -v width && $width == *[!0-9]* ]]; then
    die "Width must be a positive integer"
fi

if [[ $start_num == *[!0-9]* ]]; then
    die "Start number must be a positive integer"
fi

if [[ $increment == *[!0-9]* ]]; then
    die "Increment must be a positive integer"
fi

end_num=$((start_num + $# - 1))

format=${format/\%N/$#}

while IFS= read -r -d $'\n' num; do
    if [[ -v width ]]; then
        num=$(printf "%0${width}d" "$num")
    fi

    src=$1
    shift

    dir=$(dirname "$src")
    ext=$(extname "$src")
    base=$(basename "$src" "$ext")

    dst=$format
    dst=${dst/\%n/$num}
    dst=${dst/\%d/$dir}
    dst=${dst/\%b/$base}
    dst=${dst/\%e/$ext}

    if [[ ! -v dry_run ]]; then
        mv -i -T "$src" "$dst"
    fi

    printf "%s\n" "$dst"
done < <(seq "${seq_options[@]}" "$start_num" "$increment" "$end_num")

#!/usr/bin/env bash

set -eu

# Default options:
format="%d/%b (%n of %N)%e"
start_num=1
increment=1
width=1

me=${0##*/}
usage="Rename files as a sequence of numbers.

Usage: $me [OPTIONS] FILE...

Options:
    -h           show this help message
    -w           equalize width by padding with leading zeroes
    -n           show the renamed files without actually renaming them
    -s NUMBER    change start number (default: 1)
    -i NUMBER    change increment (default: 1)
    -W NUMBER    set the width of each number to NUMBER characters with leading zeroes
    -f FORMAT    format file basename before extension (default: '$format')

When specifying FORMAT, it can include some placeholders:
    %N           the total number of files
    %n           the number of FILE
    %d           the directory of FILE
    %b           the basename of FILE
    %e           the extension of FILE
"

usage() {
    echo "$usage" >&2
    exit 0
}

die() {
    echo "$me: $*" >&2
    exit 1
}

declare -a seq_options

unset OPTIND OPTARG
while getopts ":hf:s:i:W:wn" option; do
    case $option in
    f) format=$OPTARG ;;
    s) start_num=$OPTARG ;;
    i) increment=$OPTARG ;;
    W) width=$OPTARG ;;
    w) seq_options+=(-w) ;;
    n) noop=1 ;;
    h) usage ;;
    *) die "invalid option: $OPTARG" ;;
    esac
done && shift $((OPTIND - 1))
unset option OPTIND OPTARG

if [[ $format != *%n* ]]; then
    die "format does not contain '%n'"
fi

if [[ $width == *[!0-9]* ]]; then
    die "width must be a positive integer"
fi

if [[ $start_num == *[!0-9]* ]]; then
    die "start number must be a positive integer"
fi

if [[ $increment == *[!0-9]* ]]; then
    die "increment must be a positive integer"
fi

end_num=$((start_num + $# - 1))

format=${format/\%N/$#}

readarray -t nums < <(seq "${seq_options[@]}" "$start_num" "$increment" "$end_num")

for num in "${nums[@]}"; do
    ((width > 1)) && num=$(printf "%0${width}d" "$num")

    src=$1
    shift

    dir=$(dirname "$src")
    ext=$(extname "$src")
    base=$(basename "$src" "$ext")

    dst=$format
    dst=${dst/\%n/$num}
    dst=${dst/\%d/$dir}
    dst=${dst/\%b/$base}
    dst=${dst/\%e/$ext}

    if [[ ! -v noop ]]; then
        mv -i -T "$src" "$dst"
    fi

    echo "$dst"
done

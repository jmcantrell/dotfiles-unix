#!/usr/bin/env bash

set -eu

if [[ -f /etc/arch-release ]]; then
    sudo pacman -S --noconfirm --needed base-devel openssl xz zlib
elif [[ $OSTYPE == darwin* ]]; then
    brew install openssl readline sqlite3 xz zlib
fi

dir=${PYENV_ROOT:-$HOME/.pyenv}

if [[ -d $dir ]]; then
    cd "$dir"
    git pull origin master
else
    git clone https://github.com/pyenv/pyenv.git "$dir"
    cd "$dir"
fi

declare -A plugins

plugins["pyenv-doctor"]=https://github.com/pyenv/pyenv-doctor.git
plugins["pyenv-update"]=https://github.com/pyenv/pyenv-update.git
plugins["pyenv-virtualenv"]=https://github.com/pyenv/pyenv-virtualenv.git
plugins["pyenv-default-packages"]=https://github.com/jawshooah/pyenv-default-packages.git

for name in "${!plugins[@]}"; do
    plugin_dir=$dir/plugins/$name

    if [[ -d $plugin_dir ]]; then
        cd "$plugin_dir"
        git pull origin master
    else
        git clone "${plugins[$name]}" "$plugin_dir"
    fi
done

cat >"$dir"/default-packages <<-EOF
black
build
flake8
pip
pynvim
twine
wheel
EOF

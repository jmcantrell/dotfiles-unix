#!/usr/bin/env sh

# Sync gists with a directory.

die() {
    echo "$@" >&2
    exit 1
}

test "$GITHUB_ACCESS_TOKEN" ||
    die "GITHUB_ACCESS_TOKEN not set"

user=`git config github.user`

test "$user" ||
    die "Git config value github.user not set"

documents=${DOCUMENTS:-$HOME/Documents}
gists=$documents/gists

urls() {
    curl -s -H \
        "Authorization: token $GITHUB_ACCESS_TOKEN" \
        https://api.github.com/gists |
        jq -r ".[] | .git_pull_url"
}

repos() {
    for repo in "$gists"/*; do
        test -d "$repo"/.git && echo "$repo"
    done
}

mkdir -p "$gists"

for url in `urls`; do

    id=`basename "$url" .git`
    repo=$gists/$id

    test -d "$repo" || git clone "$url" "$repo"

    # run commands against repo
    cd "$repo"
    for command in "$@"; do
        case "$command" in
            commit)
                git add .
                git commit --allow-empty-message
                ;;
            pull)
                git pull origin master
                ;;
            push)
                git push origin master
                ;;
        esac
    done

    # symlink files to documents for convenient access
    for f in "$repo"/*; do
        fn=`basename "$f"`
        ln -sfv "$f" "$documents/$fn"
    done

done

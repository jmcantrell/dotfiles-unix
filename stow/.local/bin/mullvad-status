#!/usr/bin/env bash

set -eu

declare -A entries=(
    [Type]=.mullvad_server_type
    [Address]=.ip
    [Host]=.mullvad_exit_ip_hostname
    [Blacklisted]=.blacklisted.blacklisted
    [Country]=.country
    [City]=.city
    [Longitude]=.longitude
    [Latitude]=.latitude
    [Owner]=.organization
)

if ! json=$(curl https://am.i.mullvad.net/json 2>/dev/null); then
    echo "Status: unknown" >&2
    exit 1
fi

is() {
    jq -e "$@" <<<"$json" &>/dev/null
}

get() {
    jq -r "$@" <<<"$json"
}

entry() {
    local name=$1
    shift
    echo -e "$name:\t$*"
}

if ! is '.mullvad_exit_ip'; then
    echo "Status: disconnected" >&2
    exit 1
fi

{
    entry Status connected
    for key in "${!entries[@]}"; do
        entry "$key" "$(get "${entries[$key]}")"
    done
} | column -t -s $'\t' >&2

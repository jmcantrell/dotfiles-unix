#!/usr/bin/env bash

set -e

me=${0##*/}
usage="Bump version of a python package.
Usage: $me [-Mmbnh] [-v version]"

input() {
    local reply
    local value=${1:-value}
    local default=$2 # press enter to accept
    local prompt="Enter $value"
    test "$default" && prompt+=" [$default]"
    read -rp "$prompt: " reply
    test "$reply" || reply=$default
    echo "$reply"
    test "$reply"
}

unset OPTIND
while getopts ":hifvqMmbnv:" option; do
    case $option in
    M) major=-M ;;
    m) minor=-m ;;
    b) build=-b ;;
    n) noop=1 ;;
    v) version_new=$OPTARG ;;
    h) echo "$usage" >&2 && exit 0 ;;
    *) echo "$usage" >&2 && exit 1 ;;
    esac
done && shift $((OPTIND - 1))

dir=${1:-$PWD}
setup=$dir/setup.py
config=$dir/setup.cfg

[[ -f $setup ]] || exit 1

name=$(python "$setup" --name)
version=$(python "$setup" --version)

if [[ ! $version_new ]]; then
    default=$(semver $major $minor $build "$version")
    version_new=$(input "version for '$name'" "$default")
fi

if [[ $version != "${version_new:-$version}" ]]; then
    echo "$name: $version -> $version_new"
    [[ -z $noop ]] && op="-i"
    sed $op "/^[ \t]*version[ \t]*=/s/=.*/= $version_new/" "$config"
    sed $op "/^__version__ *=/s/= *.*/= '$version_new'/" "$name/__init__.py"
fi

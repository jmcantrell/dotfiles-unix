#!/usr/bin/env bash

set -eu

config_dir=${XDG_CONFIG_HOME:-$HOME/.config}/snip

name=${0##*/}
usage="Manage text snippets.

Usage:
    $name [OPTIONS] ACTION [NAME]

Options:
    -C DIRECTORY    directory in which to store snippets
                    (default: $config_dir)

Arguments:
    ACTION          perform action on snippet
    NAME            snippet on which to perform action

Actions:
    list            print snippet names to stdout
    path            print snippet path to stdout
    read            dump snippet to stdout
    write           create snippet from stdin
    edit            open snippet in editor
    delete          delete snippet
"

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

snippet_file() {
    printf "%s/%s" "$config_dir" "${1:?Missing snippet name}"
}

snippet_file_required() {
    local file
    file=$(snippet_file "$1")

    if [[ ! -f $file ]]; then
        die "Snippet '$name' does not exist"
    fi

    printf "%s\n" "$file"
}

do_list() {
    if [[ -d $config_dir ]]; then
        find "$config_dir" -type f -printf "%P\n"
    fi
}

do_path() {
    snippet_file "$1"
}

do_write() {
    local file
    file=$(snippet_file "$1")

    mkdir -p "$(dirname "$file")"

    cat >"$file"
}

do_read() {
    cat "$(snippet_file_required "$1")"
}

do_edit() {
    exec "${VISUAL:-$EDITOR}" "$(snippet_file_required "$1")"
}

do_delete() {
    rm -f "$(snippet_file_required "$1")"
}

while getopts ":C:h" option; do
    case $option in
    C) config_dir=$OPTARG ;;
    h)
        printf "%s\n" "$usage"
        exit
        ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

if [[ ! -v 1 ]]; then
    die "Missing action"
fi

action=$1
shift

case $action in
list | path | read | write | edit | delete) ;;
*) die "Invalid action '$action'" ;;
esac

if [[ $action == list ]]; then
    do_list
    exit 0
fi

if [[ ! -v 1 ]]; then
    die "Missing snippet name"
fi

snippet_name=$1
shift

do_"$action" "$snippet_name"

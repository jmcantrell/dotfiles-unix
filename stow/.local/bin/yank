#!/usr/bin/env bash

set -e

me=${0##*/}

usage="Yank file paths in order to operate on them in bulk.
Usage: $me -h|--help                 # show this help message
       $me -l|--list                 # list paths
       $me [-a|--add] path...        # set (or append with -a) paths
       $me -x|--exec command arg...  # execute command against paths (see \`man xargs\`)
"

cache=${XDG_CACHE_HOME:-$HOME/.cache}/yank
paths=$cache/paths

die() {
    echo "$me: $*" >&2
    exit 1
}

do_list() {
    [[ -f $paths ]] && cat "$paths"
}

do_set() {
    do_clear
    do_add "$@"
}

do_add() {
    mkdir -p "$(dirname "$paths")"
    realpath "$@" >>"$paths"
}

do_clear() {
    rm -f "$paths"
}

do_exec() {
    xargs -r -I{} "$@" <"$paths"
}

action="set"

while true; do
    [[ $1 == -* ]] || break

    pos=$1
    shift

    case "$pos" in
    -l | --list) action="list" ;;
    -a | --add) action="add" ;;
    -c | --clear) action="clear" ;;

    # If present, emaining arguments should go to exec
    -x | --exec)
        do_exec "$@"
        exit
        ;;

    -h | --help)
        echo "$usage" >&2
        exit
        ;;

    -*) die "invalid option '$pos'" ;;
    esac
done

do_"$action" "$@"

#!/usr/bin/env bash

me=${0##*/}
usage="Rename files using your preferred editor.
Usage: $me [-h] [file...]"

unset OPTIND
while getopts ":h" option; do
    case $option in
        h) echo "$usage" >&2; exit 0 ;;
        *) echo "$usage" >&2; exit 1 ;;
    esac
done && shift $(($OPTIND - 1))

# nothing was passed, so grab stdin
if (( $# == 0 )); then
    stdin=($(cat))
    set -- "${stdin[@]}"
fi

oldtmp=$(mktemp)
for fn in "$@"; do
    [[ -e "$fn" ]] && echo "$fn"
done >"$oldtmp"

newtmp=$(mktemp)
cat "$oldtmp" >"$newtmp"

if ! ${EDITOR:-vim} "$newtmp"; then
    echo "$me: edit failed"
    exit 1
fi

readarray -t oldlines <"$oldtmp"
readarray -t newlines <"$newtmp"

if (( ${#oldlines[@]} != ${#newlines[@]} )); then
    echo "$me: lines were added or removed"
    exit 1
fi

for (( i = 0; i <= ${#newlines[@]}; i += 1 )); do
    oldfn=${oldlines[$i]}
    newfn=${newlines[$i]}
    newdir=$(dirname "$newfn")
    test -d "$newdir" || mkdir -p "$newdir"
    if [[ $oldfn != $newfn ]]; then
        mv -fv "$oldfn" "$newfn"
    fi
done
